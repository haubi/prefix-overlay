#!/usr/bin/env bash

# <grobian@gentoo.org> -- 2006-10-24
# because portage now deals differently (saner) with ebuilds, we replace
# all ${EDEST} with ${D} again as "cleanup" action.  Instead we look at
# all ${D} not in a make call and ${ROOT} variables.
# <grobian@gentoo.org> -- 2006-09-22
# eapify is a small hackish script that usually does fine in adding
# EAPI="prefix" if there is not yet a EAPI=something line in the ebuild.
# Next to this, it applies ${D} -> ${EDEST} transformation to "make
# DESTDIR=${D} install".  Because of the nature of this script, running
# it multiple times should not harm.  It might, however, do wrong
# things, so always check the result.  You have been warned.

if [ -z $1 ];
then
	files="*.ebuild"
else
	files="$*"
fi

replace() {
	echo -n "  replacing $1 -> $2 ... "
	local cnt=$(sed -e "${4:-s}|$1|$2|g" "$3" | diff "$3" - | egrep "^>" | wc -l)
	if [[ $cnt > 0 ]];
	then
		sed -i -e "${4:-s}|$1|$2|g" "$3"
		echo -n "$cnt occurence"
		[[ $cnt == 1 ]] \
			&& echo "" \
			|| echo "s"
	else
		echo "not found"
	fi
}

for f in $files;
do
	echo "Processing $f"

	if [[ ${f##*.} != "eclass" ]];
	then
		unset EAPI
		echo -n "  EAPI ... "
		eval "`egrep "^EAPI=" "$f"`"

		if [[ $EAPI != "" ]];
		then
			echo "already $EAPI"
		else
			sed -i \
				-e 's|^# \$Header:.*$|&\n\nEAPI="prefix"|' \
				"$f"
			echo 'added EAPI="prefix"'
		fi
	fi

	# cleanup mess from previous portage APIs
	replace '${EDEST}' '${D}' "$f"
	replace '${PROOT}' '${EROOT}' "$f"

	# we replace all ${D} with ${ED} if not in a make ... install line
	replace '${D}' '${ED}' "$f" '/make.*install/!s'

	# replace ${ROOT} with ${EROOT}
	replace '${ROOT}' '${EROOT}' "$f"
done
