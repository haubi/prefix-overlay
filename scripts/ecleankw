#!/usr/bin/env bash
# Copyright Gentoo Foundation 2006-2007

# <grobian@gentoo.org> -- 2006-09-22
# ecleankw weeds out all keywords in $KEYWORDS of an ebuild that are not
# in $my_keywords.  Next to that, it currently drops all left over
# keywords back to ~arch.  (The script basically performs a full inner
# join, based on the nested loop algorithm.)
# For exg: this script does in fact the intersection of my_keywords and
# KEYWORDS and drops the intersection to ~arch.  In this case it's equal
# to the full inner join, because in theory we have (unique) sets.

# these need to reflect the keywords that are valid for the tree
my_keywords="
	amd64-linux ia64-linux mips-linux x86-linux
	ppc-aix
	ppc-macos x86-macos
	sparc-solaris sparc64-solaris x86-solaris
	x86-interix
	hppa-hpux ia64-hpux
	x86-fbsd"

if [[ -z $1 ]] ; then
	files="*.ebuild"
else
	files="$*"
fi

for f in $files ; do
	echo -n "Processing $f ... "
	newkw=""
	eval $(egrep "^KEYWORDS=" "$f")
	for kw in $KEYWORDS ; do
		for mkw in $my_keywords ; do
			mkws=${mkw%-linux}
			if [[ $kw == $mkws || $kw == ~$mkws ]] ; then
				newkw="$newkw ~$mkws"
				break
			fi
		done
	done
	sed -i \
		-e "s|^KEYWORDS=.*$|KEYWORDS=\"${newkw:1}\"|" \
		"$f"
	echo "${newkw:1}"
done
