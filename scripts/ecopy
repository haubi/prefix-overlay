#!/usr/bin/env bash
# Copyright Gentoo Foundation 2006-2008
# $Id$

# This probably will blow up if not ran in a Prefix environment, sorry.

RSURL="http://prefix.gentooexperimental.org/rsync-gentoo-x86"
EPREFIX=${EPREFIX:-$(portageq envvar EPREFIX)}

source "${EPREFIX}/etc/init.d/functions.sh"

if ! type -P qatom > /dev/null ; then
	ewarn "This script suggests to use qatom, please emerge"
	ewarn "app-portage/portage-utils to use this improved logic."
	QATOM="false"
fi

if [[ -z ${1} ]] ; then
	einfo
	einfo "usage: ecopy <category>/<package>"
	einfo "- make sure the scripts directory from the overlay is in your path"
	einfo "- make sure you call ecopy from the root of the overlay"
	einfo "- you can also specify a specific version, using the '=' prefix"
	einfo "and appending a version"
	einfo
	exit 0
fi

# Uses qatom to determine if the second atom is greater than the first, and
# returns true if so.
is_greater_atom() {
	if [[ $(qatom -c $1 $2 | awk '{print $2}') == "<" ]]; then
		return 0
	else
		return 1
	fi
}

# Takes input of a list of ebuild strings and uses is_greater_atom() to return
# the greatest in the list.
return_greatest() {
    max="${catpkg#*\/}-0"
    for i in $@; do
        if is_greater_atom $max $i; then
			max="${i}"
		fi
	done
	echo $max
}

# Either use qatom or fall back to a non-qatom approach which may generate false
# positive.
return_greatest_wrapper() {
	if [[ "${QATOM}" == "false" ]]; then
		echo "$( wget -q "${RSURL}/${catpkg}" -O - | \
		egrep "href=\"[^\"]+\.ebuild\"" -o | \
		sed -e 's/^href="//' -e 's/"$//' | \
		tail -n 1 )"
	else
		echo "$( return_greatest "$( \
		wget -q "${RSURL}/${catpkg}" -O - | \
		egrep "href=\"[^\"]+\.ebuild\"" -o | \
		sed -e 's/^href="//' -e 's/"$//' )" )"
	fi
}

# Mangle user input
if [[ ${1:0:1} == "=" ]] ; then # Check to see if the first char is an "="
	ebuildgrep="${1#*\/}"
	catpkg="${1#=}"       # Strip the leading "="
	catpkg="${catpkg%-*}" # Strip the trailing verion numbers
else
	catpkg="$1"
fi

if [[ ${1:0:1} == "=" ]] ; then
	# Grab the index from the current $RSURL and parse it for the list
	# of ebuilds.  Grab the specified version that the user entered.
	ebuild="$(wget -q "${RSURL}/${catpkg}" -O - | \
		egrep "href=\"[^\"]+\.ebuild\"" -o | \
		sed -e 's/^href="//' -e 's/"$//' | \
		grep $ebuildgrep
	)"
else
	# Use the wrapper function to just grab the latest version.
	ebuild="$( return_greatest_wrapper )"
fi

# TODO: fix error checking. patches welcome.
# Error checking.
if [[ -z ${ebuild} ]] ; then
	ewarn "please specify a correct specific version"
	[[ ${1:0:1} == "=" ]] \
		&& ewarn "$1 doesn't match an existing ebuild in the tree" \
		|| ewarn "example: =$1-0.2.3"
	exit -1
fi

# Copy these so the Prefix tree matches the gentoo-x86 tree. But don't if the
# $catpkg dir already exists. It is assumed that they are already there.
if [[ ! -d ${catpkg} ]]; then 
	mkdir -p "${catpkg}" && cd "$catpkg"
	wget -nv --no-glob "${RSURL}/$catpkg/ChangeLog"
	wget -nv --no-glob "${RSURL}/$catpkg/metadata.xml"
	wget -nv --no-glob "${RSURL}/$catpkg/Manifest"
else
	einfo
	einfo "It appears that $catpkg already exists. I will continue but"
	einfo "you should verify my actions"
	einfo
	cd "$catpkg"
fi

# needed for sourcing ebuild and understanding ebuild specific vars.
PF="${ebuild/.ebuild}"
P="${PF%-r[1-9]*}"
PN="${P%-*}"
PV="${P/${PN}-}"

# Get the ebuild
wget -nv --no-glob "${RSURL}/${catpkg}/${ebuild}"

source ${ebuild} 2> /dev/null #get rid of "inherit: command not found" message.

# Get the patches. Assumed that every patch has FILESDIR in the line. Good
# assumption.
for i in $(eval echo $(grep FILESDIR $ebuild | sed -e 's:.*FILESDIR[}"]*/::' -e 's:"::g' -e "s:'::" -e "s:#.*::" -e "s: .*::")); do
	mkdir -p "files"
	wget -nv --no-glob -P "files" "${RSURL}/$catpkg/files/$i"
done

# Set explicit PATHs for scripts in the prefix tree so they don't need to be
# copied to your PATH. IOW, you always want eapify & ecleankw to be ran.
"${EPREFIX}/usr/portage/scripts/eapify" ${ebuild}
"${EPREFIX}/usr/portage/scripts/ecleankw" ${ebuild}
source "${EPREFIX}/etc/make.profile/make.defaults"

# Force the user's keyword on the ebuild. Less work for the user.
if ! type -P ekeyword > /dev/null ; then
	einfo
	einfo "ekeyword not found! Please emerge app-portage/gentoolkit-dev then run '$(eval echo ekeyword "~${ACCEPT_KEYWORDS#\~}" $ebuild)' manually"
else
	ekeyword "~${ACCEPT_KEYWORDS#\~}" $ebuild
fi

ebuild ${ebuild} digest #re-digest for changes made to the ebuild above
